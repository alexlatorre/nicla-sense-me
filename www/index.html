<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nicla V9.4 - Dashboard Postura</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --text: #c9d1d9; 
            --accent: #58a6ff; --danger: #ff7b72; --success: #3fb950;
            --warn: #d29922; --info: #d2a8ff; --purple: #a371f7;
            --badge-bg: #30363d;
        }
        /* 
         * GLOBAL STYLES
         * - Dark mode variables defined in :root for easy theming.
         * - Key colors: Accent (Blue), Danger (Red), Success (Green), Warn (Yellow).
         */
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; margin: 0;}
        
        .header { margin-bottom: 20px; }
        button { 
            padding: 12px 30px; border-radius: 8px; border: none; 
            background: #238636; color: white; font-weight: bold; 
            cursor: pointer; font-size: 1rem; transition: 0.2s;
        }
        button:hover { background: #2ea043; }
        
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; max-width: 1200px; margin: 0 auto; 
            opacity: 0.3; pointer-events: none; transition: opacity 0.5s;
        }
        .card { 
            background: var(--card); padding: 15px; border-radius: 12px; 
            border: 1px solid #30363d; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        }
        h3 { margin: 0 0 15px 0; font-size: 0.8rem; text-transform: uppercase; color: #8b949e; border-bottom: 1px solid #30363d; padding-bottom: 8px; }

        /* COMPASS */
        .compass-row { display: flex; justify-content: space-around; }
        .compass-wrapper { position: relative; width: 90px; text-align: center; }
        .compass-circle {
            width: 80px; height: 80px; border: 2px solid #30363d; border-radius: 50%;
            background: radial-gradient(circle, #21262d 0%, #0d1117 100%);
            position: relative; margin: 0 auto; display: flex; justify-content: center; align-items: center;
        }
        .needle {
            width: 3px; height: 45%; background: var(--accent);
            position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center;
            transform: translateX(-50%); transition: transform 0.1s linear;
        }
        .mark { position: absolute; font-size: 0.6rem; color: #484f58; font-weight: bold; }
        .mark.n { top: 3px; color: var(--danger); }
        .val-display { font-size: 1rem; font-weight: bold; margin-top: 5px; font-family: monospace;}
        .cardinal { font-size: 0.8rem; color: var(--warn); font-weight: bold; display: block;}

        /* POSTURE BADGE */
        .posture-badge {
            background: var(--badge-bg); color: white; padding: 8px; border-radius: 6px;
            font-weight: bold; margin-top: 15px; border: 1px solid #484f58;
            transition: background 0.3s;
        }

        /* BARS */
        .bar-container { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.8rem; }
        .bar-track { flex-grow: 1; height: 6px; background: #21262d; border-radius: 3px; margin: 0 10px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); width: 0%; position: absolute; left: 50%; transition: 0.05s; }
        
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid #21262d; padding: 6px 0; font-size: 0.9rem;}
        .data-val { font-weight: bold; font-family: monospace; }
        .alt-val { color: var(--info); font-size: 1.1rem; }

        /* --- PASTE INSIDE <style> --- */
        .air-quality-badge {
            display: inline-block;
            background: #30363d; color: #fff; 
            padding: 4px 10px; border-radius: 12px;
            font-size: 2rem; font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Nicla Monitor <span style="color:var(--warn)">V9.4</span></h1>
        <div id="status">Waiting for connection...</div>
        <br><button id="connectBtn">CONNECT</button>
    </div>

    <div class="grid" id="uiGrid">
        
        <div class="card">
            <h3>üí® Air Quality</h3>
            <div style="text-align:center; margin-top:10px">
                <span style="font-size:0.9rem; color:#8b949e">RESISTANCE (GAS)</span><br>
                <span id="valGas" class="data-val" style="color:var(--purple); font-size:1.2rem;">-- Œ©</span>
                <br>
                <span id="gasBadge" class="air-quality-badge">Measuring...</span>
            </div>
        </div>
        
        <div class="card">
            <h3>üß≠ Orientation & Posture</h3>
            
            <div id="postureDisplay" class="posture-badge">‚è≥ Waiting for data...</div>
            <br>

            <div class="compass-row">
                <div class="compass-wrapper">
                    <div style="font-size:0.7rem;">HEADING</div>
                    <div class="compass-circle">
                        <div class="mark n">N</div>
                        <div id="needleHeading" class="needle" style="background:var(--danger)"></div>
                    </div>
                    <div id="valHeading" class="val-display">0¬∞</div>
                    <span id="cardinalHeading" class="cardinal">--</span> </div>
                <div class="compass-wrapper">
                    <div style="font-size:0.7rem;">ROLL</div>
                    <div class="compass-circle">
                        <div id="needleRoll" class="needle"></div>
                    </div>
                    <div id="valRoll" class="val-display">0¬∞</div>
                </div>
            </div>
            
            <div class="bar-container" style="margin-top:15px">
                <span style="width:40px">PITCH</span>
                <div class="bar-track"><div id="barPitch" class="bar-fill"></div></div>
                <span id="valPitch" style="width:35px; text-align:right">0</span>
            </div>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Gravity (XYZ)</h3>
            <div class="bar-container">
                <span style="width:15px">X</span>
                <div class="bar-track"><div id="barGx" class="bar-fill" style="background:var(--success)"></div></div>
                <span id="valGx" style="width:40px; text-align:right">0.0</span>
            </div>
            <div class="bar-container">
                <span style="width:15px">Y</span>
                <div class="bar-track"><div id="barGy" class="bar-fill" style="background:var(--success)"></div></div>
                <span id="valGy" style="width:40px; text-align:right">0.0</span>
            </div>
            <div class="bar-container">
                <span style="width:15px">Z</span>
                <div class="bar-track"><div id="barGz" class="bar-fill" style="background:var(--success)"></div></div>
                <span id="valGz" style="width:40px; text-align:right">0.0</span>
            </div>
            <p style="font-size:0.7rem; color:#666; margin-top:5px">Used to calculate posture.</p>
        </div>

        <div class="card">
            <h3>üöÄ Motion</h3>
            <div class="bar-container">
                <span style="width:15px">X</span>
                <div class="bar-track"><div id="barAx" class="bar-fill" style="background:var(--warn)"></div></div>
                <span id="valAx" style="width:40px; text-align:right">0.0</span>
            </div>
            <div class="bar-container">
                <span style="width:15px">Y</span>
                <div class="bar-track"><div id="barAy" class="bar-fill" style="background:var(--warn)"></div></div>
                <span id="valAy" style="width:40px; text-align:right">0.0</span>
            </div>
            <div class="bar-container">
                <span style="width:15px">Z</span>
                <div class="bar-track"><div id="barAz" class="bar-fill" style="background:var(--warn)"></div></div>
                <span id="valAz" style="width:40px; text-align:right">0.0</span>
            </div>
        </div>

        <div class="card">
            <h3>üå°Ô∏è Environment</h3>
            <div class="data-row">
                <span>Altitude</span>
                <span id="valAlt" class="data-val alt-val">-- m</span>
            </div>
            <div class="data-row">
                <span>Temp</span>
                <span id="valTemp" class="data-val">-- ¬∞C</span>
            </div>
            <div class="data-row">
                <span>Humidity</span>
                <span id="valHum" class="data-val">-- %</span>
            </div>
            <div class="data-row">
                <span>Pressure</span>
                <span id="valPress" class="data-val">-- hPa</span>
            </div>
        </div>

        <div class="card">
            <h3>üîã System</h3>
            <div style="text-align:center; margin-top:10px">
                <div id="batIcon" style="font-size: 2rem;">üîã</div>
                <div id="batStatusText" style="font-weight:bold; font-size:0.8rem; margin-top:5px; margin-bottom: 5px;">...</div>
                <button id="resetBtn" style="background:var(--danger); font-size:0.7rem; padding: 5px 10px; margin-top:5px; width:100%; max-width:120px" onclick="resetBoard()">REBOOT BOARD</button>
            </div>
        </div>

    </div>

    <script>
        // ------------------------------------------------------------------
        // CONFIGURATION & UUIDS
        // ------------------------------------------------------------------
        // Service UUID must match the Arduino definitions.
        const SERVICE_UUID = "19B10000-0000-0000-0000-000000000000";
        
        // Dictionary mapping internal keys to their respective Characteristic UUIDs.
        const UUIDS = {
            heading: "19b10001-0000-0000-0000-000000000000",
            pitch:   "19b10002-0000-0000-0000-000000000000",
            roll:    "19b10003-0000-0000-0000-000000000000",
            vecGravity: "19b10004-0000-0000-0000-000000000000",
            vecAccel:   "19b10013-0000-0000-0000-000000000000", 
            temp:    "19b10007-0000-0000-0000-000000000000",
            hum:     "19b10008-0000-0000-0000-000000000000",
            press:   "19b10009-0000-0000-0000-000000000000",
            gas:     "19b10010-0000-0000-0000-000000000000",
            bat:     "19b10011-0000-0000-0000-000000000000",
            alt:     "19b10012-0000-0000-0000-000000000000",
            reset:   "19b10014-0000-0000-0000-000000000000"
        };

        const btn = document.getElementById('connectBtn');
        const statusDiv = document.getElementById('status');

        // SENSOR CONSTANTS
        // The Nicla sends raw integer values for Gravity/Accel.
        // The scale is 4096 units = 1 G (9.8 m/s^2).
        const SENSOR_SCALE = 4096.0; 

        btn.addEventListener('click', async () => {
            try {
                statusDiv.innerText = "Connecting...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Nicla' }],
                    optionalServices: [SERVICE_UUID.toLowerCase()]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID.toLowerCase());
                
                // Save service globally for reset function
                window.niclaService = service;

                statusDiv.innerText = "üü¢ Connected & Calibrated";
                // Reveal the dashboard UI
                // Reveal the dashboard UI
                const uiGrid = document.getElementById('uiGrid');
                uiGrid.style.opacity = 1;
                uiGrid.style.pointerEvents = 'auto'; // FIX: Re-enable clicks
                btn.style.display = 'none';

                // -----------------------------------------
                // 1. SETUP NOTIFICATIONS
                // -----------------------------------------
                // We subscribe to all characteristics to receive real-time updates.
                
                // Orientation (Heading, Pitch, Roll)
                // Orientation (Heading, Pitch, Roll) - Combined Vector
                // Reusing UUIDS.heading as the base for the orientation vector
                await setupVectorChar(service, UUIDS.heading, (h, p, r) => {
                    updateHeading(h);
                    updateBar('Pitch', p, 90);
                    updateCompass('Roll', r);
                });

                // 2. GRAVITY (Divide by 4096)
                await setupVectorChar(service, UUIDS.vecGravity, (x, y, z) => {
                    let gx = x / SENSOR_SCALE;
                    let gy = y / SENSOR_SCALE;
                    let gz = z / SENSOR_SCALE;
                    
                    updateBar('Gx', gx, 1.5);
                    updateBar('Gy', gy, 1.5);
                    updateBar('Gz', gz, 1.5);
                    calculatePosture(gx, gy, gz); // Posture will work now
                });

                // 3. ACCELERATION (Divide by 4096)
                await setupVectorChar(service, UUIDS.vecAccel, (x, y, z) => {
                    let ax = x / SENSOR_SCALE;
                    let ay = y / SENSOR_SCALE;
                    let az = z / SENSOR_SCALE;

                    updateBar('Ax', ax, 2.0); 
                    updateBar('Ay', ay, 2.0);
                    updateBar('Az', az, 2.0);
                });

                // Environmental Sensors
                await setupChar(service, UUIDS.temp, (v) => setText('valTemp', v.toFixed(1) + " ¬∞C"));
                await setupChar(service, UUIDS.hum, (v) => setText('valHum', Math.round(v) + " %"));
                await setupChar(service, UUIDS.press, (v) => setText('valPress', Math.round(v) + " hPa"));
                await setupChar(service, UUIDS.alt, (v) => setText('valAlt', v.toFixed(1) + " m"));
                await setupCharInt(service, UUIDS.gas, (v) => {
                    setText('valGas', v + " Œ©");
                    evaluateAirQuality(v); // Trigger air quality update
                });
                await setupCharByte(service, UUIDS.bat, updateBattery);

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "Disconnected / Error";
                btn.style.display = 'inline-block';
            }
        });


        // ------------------------------------------------------------------
        // BUSINESS LOGIC
        // ------------------------------------------------------------------
        /* 
         * Function: calculatePosture
         * Determines the physical orientation of the device based on the Gravity Vector.
         * Logic:
         * - Finds the axis with the highest absolute gravity value (dominant axis).
         * - Checks the sign (+/-) to determine direction (Up/Down).
         * - Updates the posture badge UI.
         */
        
        function calculatePosture(x, y, z) {
            const badge = document.getElementById('postureDisplay');
            const absX = Math.abs(x); const absY = Math.abs(y); const absZ = Math.abs(z);
            let text = "Desconocido"; let color = "#30363d";

            // Minimum threshold to avoid noise (0.5G)
            if (absX < 0.2 && absY < 0.2 && absZ < 0.2) {
                badge.innerText = "‚ö†Ô∏è INVALID DATA"; badge.style.background = "#30363d"; return;
            }

            if (absZ > absX && absZ > absY) {
                if (z > 0) { text = "‚¨ÜÔ∏è FACE UP"; color = "#238636"; }
                else       { text = "‚¨áÔ∏è FACE DOWN";  color = "#da3633"; }
            } else if (absY > absX && absY > absZ) {
                // Y Axis: USB cable is usually up or down
                if (y > 0) { text = "‚ÜïÔ∏è VERTICAL (USB DOWN)"; color = "#9a6700"; }
                else       { text = "‚ÜïÔ∏è VERTICAL (USB UP)"; color = "#9a6700"; }
            } else {
                if (x > 0) { text = "‚¨ÖÔ∏è ON SIDE (LEFT)"; color = "#1f6feb"; }
                else       { text = "‚û°Ô∏è ON SIDE (RIGHT)"; color = "#1f6feb"; }
            }
            badge.innerText = text; badge.style.background = color;
        }

        /*
         * Function: updateHeading
         * Rotates the compass needle CSS transform based on the 0-360 degree value.
         * Also converts degree to Cardinal Direction (N, NE, E...) for display.
         */
        function updateHeading(val) {
            document.getElementById('valHeading').innerText = Math.round(val) + "¬∞";
            document.getElementById('needleHeading').style.transform = `translateX(-50%) rotate(${val}deg)`;
            const directions = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
            const index = Math.round(val / 45) % 8;
            document.getElementById('cardinalHeading').innerText = directions[index];
        }

        // ------------------------------------------------------------------
        // BLUETOOTH HELPER FUNCTIONS
        // ------------------------------------------------------------------
        /*
         * Generic helpers to:
         * 1. Get characteristic from service.
         * 2. Start Notifications (subscribe).
         * 3. Add event listener for 'characteristicvaluechanged'.
         * 4. Parse DataView based on type (Float32, Int32, Uint8).
         */
        async function setupChar(service, uuid, cb) {
            try {
                const c = await service.getCharacteristic(uuid); await c.startNotifications();
                c.addEventListener('characteristicvaluechanged', (e) => cb(e.target.value.getFloat32(0, true)));
            } catch(e) {}
        }
        async function setupVectorChar(service, uuid, cb) {
            try {
                const c = await service.getCharacteristic(uuid); await c.startNotifications();
                c.addEventListener('characteristicvaluechanged', (e) => {
                    const d = e.target.value;
                    cb(d.getFloat32(0, true), d.getFloat32(4, true), d.getFloat32(8, true));
                });
            } catch(e) {}
        }
        async function setupCharInt(service, uuid, cb) {
            try {
                const c = await service.getCharacteristic(uuid); await c.startNotifications();
                c.addEventListener('characteristicvaluechanged', (e) => cb(e.target.value.getInt32(0, true)));
            } catch(e) {}
        }
        async function setupCharByte(service, uuid, cb) {
            try {
                const c = await service.getCharacteristic(uuid); await c.startNotifications();
                c.addEventListener('characteristicvaluechanged', (e) => cb(e.target.value.getUint8(0)));
            } catch(e) {}
        }

        function setText(id, val) { document.getElementById(id).innerText = val; }
        function updateCompass(type, val) {
            document.getElementById('val'+type).innerText = Math.round(val) + "¬∞";
            const rot = type === 'Heading' ? val : -val;
            document.getElementById('needle'+type).style.transform = `translateX(-50%) rotate(${rot}deg)`;
        }
        function updateBar(suffix, val, max) {
            document.getElementById('val'+suffix).innerText = val.toFixed(2);
            if(val > max) val = max; if(val < -max) val = -max;
            const pct = (Math.abs(val)/max)*50;
            const bar = document.getElementById('bar'+suffix);
            bar.style.width = pct + "%";
            bar.style.left = (val < 0) ? (50 - pct)+"%" : "50%";
        }
        function updateBattery(code) {
            const t = document.getElementById('batStatusText');
            if(code===1) t.innerText="CHARGING"; else if(code===2) t.innerText="FULL";
            else if(code===3) t.innerText="CRITICAL"; else t.innerText="IN USE";
        }
        function evaluateAirQuality(ohms) {
    const badge = document.getElementById('gasBadge');
    let text = ""; let color = "";

    // Logic: Higher resistance = cleaner air
    if (ohms > 50000) { text = "‚ú® VERY GOOD"; color = "#238636"; }
    else if (ohms > 20000) { text = "üåø GOOD"; color = "#3f6d46"; }
    else if (ohms > 10000) { text = "üòê MODERATE"; color = "#d29922"; }
    else if (ohms > 5000) { text = "üò∑ POOR"; color = "#da3633"; }
    else { text = "üíÄ VERY POOR"; color = "#82071e"; }

    badge.innerText = text;
    badge.style.backgroundColor = color;
}

// REMOTE RESET FUNCTION
async function resetBoard() {
    if (!window.niclaService) return;
    if (!confirm("‚ö†Ô∏è REBOOT BOARD?\nThis will disconnect Bluetooth.")) return;
    
    try {
        const c = await window.niclaService.getCharacteristic(UUIDS.reset);
        const resetCmd = new Uint8Array([1]);
        
        // Try WriteWithoutResponse first (faster, no ack needed)
        if (c.properties.writeWithoutResponse) {
             await c.writeValueWithoutResponse(resetCmd);
        } else {
             // Fallback to normal write, but catch the disconnect error
             // because the board resets immediately
             c.writeValue(resetCmd).catch(() => {});
        }
        
        alert("Reboot command sent. Reconnecting...");
        location.reload(); 
    } catch(e) {
        // If we get here, likely getting the characteristic failed
        console.error(e);
        alert("Error sending reset: " + e);
    }
}
    </script>
</body>
</html>